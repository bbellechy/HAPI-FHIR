<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>Hospital FHIR Connector</title>
  <style>
    body { font-family: sans-serif; margin: 2em; }
    input, button, select { margin: 0.5em 0; padding: 0.5em; }
    table { width: 100%; margin-top: 1em; border-collapse: collapse; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; }
    button.action { margin-right: 0.3em; }
    a { color: blue; text-decoration: underline; cursor: pointer; }
    #patientDetails { border: 1px solid #ddd; padding: 1em; margin-top: 1em; background: #f9f9f9; }
  </style>
</head>
<body>
<h1>HIS1</h1>
<h2>üè• ‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ (FHIR Patients)</h2>
<button onclick="loadPatients()">‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠</button>
<table id="patientTable">
  <thead>
    <tr>
      <th>ID</th><th>‡∏ä‡∏∑‡πà‡∏≠</th><th>‡πÄ‡∏û‡∏®</th><th>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î</th><th>‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏ä‡∏±‡∏ô</th><th>action</th>
    </tr>
  </thead>
  <tbody></tbody>
</table>

<div id="patientDetails"></div>

<hr>

<h3 id="formTitle">‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</h3>
<input id="firstName" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á">
<input id="lastName" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•">
<input id="birthDate" type="date">
<select id="gender">
  <option value="male">‡∏ä‡∏≤‡∏¢</option>
  <option value="female">‡∏´‡∏ç‡∏¥‡∏á</option>
</select>
<br>
<button onclick="addOrUpdatePatient()">üíæ ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å</button>
<button onclick="resetForm()">üîÑ ‡∏•‡πâ‡∏≤‡∏á‡∏ü‡∏≠‡∏£‡πå‡∏°</button>

<script>
const FHIR_BASE = 'http://localhost:8080/fhir'; 
let editingPatientId = null;
let currentPatientResource = null;

function loadPatients() {
  fetch(`${FHIR_BASE}/Patient?_count=20`)
    .then(res => res.json())
    .then(data => {
      const tbody = document.querySelector("#patientTable tbody");
      tbody.innerHTML = "";
      if (data.entry) {
        data.entry.forEach(entry => {
          const p = entry.resource;
          const name = p.name?.[0]?.given?.join(" ") + " " + p.name?.[0]?.family;
          const gender = p.gender || "-";
          const birth = p.birthDate || "-";
          const version = p.meta?.versionId || "-";
          const nameHtml = `<a href="#" onclick="viewPatient('${p.id}')">${name}</a>`;
          const row = `
            <tr>
              <td>${p.id}</td>
              <td>${nameHtml}</td>
              <td>${gender}</td>
              <td>${birth}</td>
              <td>${version}</td>
              <td>
                <button class="action" onclick="editPatient('${p.id}')">üìù ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                <button class="action" onclick="deletePatient('${p.id}')">üóëÔ∏è ‡∏•‡∏ö</button>
              </td>
            </tr>`;
          tbody.insertAdjacentHTML('beforeend', row);
        });
      }
    });
}

function addOrUpdatePatient() {
  const fName = document.getElementById("firstName").value.trim();
  const lName = document.getElementById("lastName").value.trim();
  const birth = document.getElementById("birthDate").value;
  const gender = document.getElementById("gender").value;

  let patient;

  if (editingPatientId && currentPatientResource) {
    patient = {
      ...currentPatientResource,
      name: [{ use: "official", family: lName, given: [fName] }],
      gender: gender,
      birthDate: birth
    };
  } else {
    patient = {
      resourceType: "Patient",
      name: [{ use: "official", family: lName, given: [fName] }],
      gender: gender,
      birthDate: birth
    };
  }

  const method = editingPatientId ? "PUT" : "POST";
  const url = editingPatientId ? `${FHIR_BASE}/Patient/${editingPatientId}` : `${FHIR_BASE}/Patient`;

  fetch(url, {
    method: method,
    headers: { "Content-Type": "application/fhir+json" },
    body: JSON.stringify(patient)
  }).then(async res => {
    if (res.ok) {
      alert(editingPatientId ? "‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à" : "‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
      resetForm();
      loadPatients();
    } else {
      const text = await res.text();
      console.error("‚õîÔ∏è PUT/POST error:", text);
      alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•:\n" + text);
    }
  });
}

function editPatient(id) {
  fetch(`${FHIR_BASE}/Patient/${id}`)
    .then(res => res.json())
    .then(p => {
      currentPatientResource = p;
      document.getElementById("firstName").value = p.name?.[0]?.given?.[0] || "";
      document.getElementById("lastName").value = p.name?.[0]?.family || "";
      document.getElementById("birthDate").value = p.birthDate || "";
      document.getElementById("gender").value = p.gender || "male";
      editingPatientId = id;
      document.getElementById("formTitle").textContent = "‚úèÔ∏è ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ";
    });
}

function deletePatient(id) {
  if (confirm("‡∏Ñ‡∏∏‡∏ì‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà?")) {
    fetch(`${FHIR_BASE}/Patient/${id}`, {
      method: "DELETE"
    }).then(res => {
      if (res.ok) {
        alert("‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à");
        loadPatients();
      } else {
        alert("‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•");
      }
    });
  }
}

function viewPatient(id) {
  fetch(`${FHIR_BASE}/Patient/${id}`)
    .then(res => res.json())
    .then(p => {
      const detailDiv = document.getElementById("patientDetails");
      const name = p.name?.[0]?.given?.join(" ") + " " + p.name?.[0]?.family;
      const gender = p.gender || "-";
      const birth = p.birthDate || "-";
      const telecom = (p.telecom || []).map(t => `${t.system}: ${t.value}`).join(", ");

      detailDiv.innerHTML = `
        <h3>üìã ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ</h3>
        <p><strong>‡∏ä‡∏∑‡πà‡∏≠:</strong> ${name}</p>
        <p><strong>‡πÄ‡∏û‡∏®:</strong> ${gender}</p>
        <p><strong>‡∏ß‡∏±‡∏ô‡πÄ‡∏Å‡∏¥‡∏î:</strong> ${birth}</p>
        <p><strong>‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠:</strong> ${telecom || '-'}</p>
        <p><strong>ID:</strong> ${p.id}</p>
        <hr>
      `;
    });
}

function resetForm() {
  document.getElementById("firstName").value = "";
  document.getElementById("lastName").value = "";
  document.getElementById("birthDate").value = "";
  document.getElementById("gender").value = "male";
  editingPatientId = null;
  currentPatientResource = null;
  document.getElementById("formTitle").textContent = "‚ûï ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ñ‡∏ô‡πÑ‡∏Ç‡πâ";
}
</script>

</body>
</html>
